# Souns 扫描逻辑
## 一、核心目标

通过递归扫描用户指定目录，完成所有支持类型音频文件的索引建立，包含文件哈希、元数据（metadata）、关联资源（封面、MV、歌词）等信息，同时提供实时进度反馈。

## 二、扫描流程总览

### 初始化配置

- 定义支持的文件类型（音频：mp3、flac、wav等；关联资源：封面jpg/png、MV mp4/mkv、歌词lrc等），并预设对应的文件标头特征（如mp3标头ID3、flac标头fLaC）。
- 初始化进度计数器（总目录数、总文件数、已完成数）、暂存变量（文件哈希列表、待索引信息队列）及SQL连接（用于执行索引语句）。

### 第一阶段：目录递归扫描（进度监控层）

- 递归遍历用户提供的所有根目录，收集所有子目录路径，统计总目录数。
- 每进入一个目录/完成一个目录扫描，触发进度事件（包含当前目录路径、已完成目录数/总目录数、进度百分比），支持开发层监听并展示（如UI进度条）。

### 第二阶段：文件递归扫描与处理（核心逻辑层）

- 基于第一阶段收集的目录，递归遍历所有文件，按以下流程处理：

## 三、文件处理详细逻辑

1. 文件类型判断

- 读取文件前4-8字节标头，与预设的支持类型标头比对，筛选出音频文件及关联资源文件。
- 非支持类型文件直接跳过，不进入后续流程。

2. 音频文件处理（核心）
- 步骤1：计算文件哈希
使用MD5/SHA-1算法计算音频文件哈希值（唯一标识），暂存至变量file_hash。
- 骤2：获取元数据（metadata）
- 尝试通过音频文件内置元数据（如mp3的ID3标签、flac的VORBIS COMMENT）读取信息（艺术家、歌曲名、专辑、时长等）。
- 若成功：直接组合file_hash + metadata，生成SQL索引语句（如INSERT INTO songs (...) VALUES (...)），执行后进入下一次递归。
- 若失败：进入文件名解析逻辑。
- 步骤3：文件名解析（metadata获取失败时）
- 按预设格式解析文件名：艺术家 - 歌曲名.扩展名（支持空格、下划线等分隔符兼容），提取artist和song_name暂存。
- 查找同级目录中关联资源：
- 专辑封面：匹配艺术家 - 歌曲名.jpg/专辑名.png等，转换为Base64编码暂存。
- MV文件：匹配艺术家 - 歌曲名.mp4等，记录绝对路径暂存。
- 歌词文件：匹配艺术家 - 歌曲名.lrc，读取文本内容暂存。
- 组合file_hash + 解析的artist/song_name + 关联资源信息，生成SQL索引语句并执行，进入下一次递归。

3. 关联资源文件处理
- 非音频的关联资源（封面、MV、歌词）不单独建立索引，仅在对应音频文件处理时被关联引用（避免重复存储）。

## 四、进度反馈机制

	•	递归返回值：每次递归结束（处理完一个文件/目录），返回当前进度数据（{已处理文件数, 总文件数, 当前文件路径, 进度%}）。

	•	事件触发：通过回调函数（如onProgress(progressData)）实时推送进度，支持开发层按需处理（如日志打印、UI更新）。

## 五、异常处理

	1.	目录访问失败：记录错误日志（如无权限、目录不存在），跳过该目录，继续扫描其他目录，进度事件标记“部分目录未访问”。

	2.	文件读取失败：对损坏文件/加密文件，记录错误信息（{file_path, error: "读取失败"}），跳过处理，不中断整体扫描。

	3.	SQL执行失败：索引语句执行失败时（如重复索引），重试1次，仍失败则记录到错误队列，扫描完成后统一输出。

## 六、扫描结束条件

	•	所有目录递归遍历完成，所有支持类型的音频文件均完成处理（成功索引或记录错误），返回最终结果：

	◦	成功索引文件数、总扫描文件数、错误文件列表、耗时统计。

## 七、开发层注意事项

	1.	需实现文件标头识别工具类、哈希计算工具类、元数据解析工具类（可依赖成熟库，如ffmpeg、taglib）。

	2.	SQL索引表需包含字段：file_hash（主键）、artist、song_name、album、duration、cover_base64、mv_path、lyrics、file_path、create_time。

	3.	大目录扫描建议开启多线程（注意线程安全，哈希计算、文件读取可并行，SQL操作需加锁）。

通过以上逻辑，可确保扫描过程高效、稳定，且索引信息完整，满足后续功能（如歌曲检索、关联资源调用）的需求。